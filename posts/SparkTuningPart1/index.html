<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Spark Tuning과 관련된 몇 가지 발견들 | Kwon_sun_cheol</title><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Spark Tuning과 관련된 몇 가지 발견들" /><meta name="author" content="Kwon Suncheol" /><meta property="og:locale" content="en_US" /><meta name="description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><meta property="og:description" content="A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation." /><link rel="canonical" href="https://classicmania.github.io/posts/SparkTuningPart1/" /><meta property="og:url" content="https://classicmania.github.io/posts/SparkTuningPart1/" /><meta property="og:site_name" content="Kwon_sun_cheol" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-21T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Spark Tuning과 관련된 몇 가지 발견들" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Kwon Suncheol" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Spark Tuning과 관련된 몇 가지 발견들","description":"A minimal, portfolio, sidebar, bootstrap Jekyll theme with responsive web design and focuses on text presentation.","datePublished":"2021-02-21T00:00:00+09:00","dateModified":"2021-02-21T00:00:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://classicmania.github.io/posts/SparkTuningPart1/"},"url":"https://classicmania.github.io/posts/SparkTuningPart1/","author":{"@type":"Person","name":"Kwon Suncheol"},"@context":"https://schema.org"}</script><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script src="/assets/js/post.min.js" async></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); </script> <script src="/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/polymath.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Kwon_sun_cheol</a></div><div class="site-subtitle font-italic">Data lover</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/classicmania" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://classicmania33.medium.com/" target="_blank"> <i class="fab fa-medium"></i> </a> <a href="https://www.linkedin.com/in/%EC%88%9C%EC%B2%A0-%EA%B6%8C-9218a8180/" target="_blank"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Spark Tuning과 관련된 몇 가지 발견들</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Spark Tuning과 관련된 몇 가지 발견들</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 21, 2021, 12:00 AM +0900" > Feb 21 <i class="unloaded">2021-02-21T00:00:00+09:00</i> </span> by <span class="author"> Kwon Suncheol </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 14, 2021, 4:02 PM +0900" > Mar 14 <i class="unloaded">2021-03-14T16:02:16+09:00</i> </span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post_img/Apache_spark.png" alt="spark" /></p><p><br /></p><p>최근에 고객 세분화(Customer Segmentation) RFM 모델 디버깅 작업과 팀원 중 한분께서 Session Based RS를 고안하실 때 필요한 순차 데이터(Sequential Data) 전처리 작업을 스파크로 진행하면서 경험하였던 것들 중 몇 가지를 공유하고자 합니다.</p><p><br /></p><h2 id="spark-tuning">Spark Tuning</h2><hr /><h3 id="몇-가지-전제들">몇 가지 전제들</h3><p>‘Data Skewness in spark’를 전개 하기 위해서 필요한 몇 가지 점들을 공유하겠습니다. <br /></p><p>스파크는 기본적으로 다음 이미지와 같이 동작합니다. Local Mode도 지원하지만 실무에서는 Cluster Mode를 일반적으로 활용합니다. 스파크 애플리케이션의 개수가 RFM 뿐만 아니라 다른 어플리케이션도 존재하므로 클러스터 매니저는 YARN으로 설정하고 처리해야 하는 데이터의 기간이 길고 크므로 Driver Memory와 Executor Memory는 충분히 지정하였습니다.</p><p><br /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post_img/Spark_Structure_cluster_mode.png" alt="spark_cluster_structure" /></p><p><br /></p><p>다음으로 스파크가 제공하는 Join에 대해 살펴보겠습니다. 스파크는 아래의 표와 같이 다양한 조인 표현식(Join Expression)을 제공합니다.</p><p><br /></p><div class="table-wrapper"><table><thead><tr><th style="text-align: center"> <th style="text-align: center">공통의 키<th style="text-align: center">ROW 처리 방법<tbody><tr><td style="text-align: center">Inner Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Left dataset key and Right dataset key<tr><td style="text-align: center">Outer Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Left dataset key or Right dataset key<tr><td style="text-align: center">Left Outer Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Left dataset Key only<tr><td style="text-align: center">Right Outer Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Right dataset key only<tr><td style="text-align: center">Left Semi Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Left data set key matching Right dataset key<tr><td style="text-align: center">Left Anti Join<td style="text-align: center"><span style="color:red">O</span><td style="text-align: center">Left data set key not maching Right dataset key<tr><td style="text-align: center">Natural Join<td style="text-align: center"><span style="color:red">X</span><td style="text-align: center">Implicit join<tr><td style="text-align: center">Cross Join<td style="text-align: center"><span style="color:red">X</span><td style="text-align: center">Catesian Join</table></div><p><br /></p><p>조인할 때 스파크는 셔플 조인(Shuffle Join)과 브로드캐스트 조인(Broadcast Join)방식 중 하나의 통신 방식을 사용합니다.</p><ul><li>Shuffle Join<ul><li>Shuffle Join은 전체의 노드간의 통신을 발생 시킵니다.<li>개별 데이터프레임의 파티션에서 Data Skewness가 발생할 경우 Shuffle Join의 Cost는 기하급수적으로 늘어날 것입니다.<li>일반적으로 Join의 대상이 되는 테이블이 클 경우 Shuffle Join이 활용됩니다.</ul><li>Broadcast Join<ul><li>Shuffle Join과 다르게 Broadcast Join은 Join의 대상이 되는 테이블의 크기 차이가 클 경우 적용됩니다.<li>만약 Low Level이 아닌 High Level API를 활용하면 Optimizer에서 Broadcast join을 사용하도록 힌트를 줄 수 있지만 일반적으로 스파크 자체내에서 자동으로 Broadcast 방식으로 통신하는 것을 쉽게 알 수 있습니다.</ul></ul><p><br /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post_img/Broadcast_join_spark.jpg" alt="Broadcast_join_spark" /></p><p><br /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post_img/Shuffle_Hash_join_spark.jpg" alt="Shuffle_hash_join_spark" /></p><p><br /></p><p>특히 Cross Join을 시행할 때는 두 가지 경우의 수가 있을 것입니다. <br /></p><ul><li>Small DataFrame Cross Join<ul><li>만약 Join의 대상이 크지 않을 경우 데이터프레임의 파티션은 다음과 같을 것입니다.<li>\(\ N(Partitions) \,of \,left \,DF = \,N(Partitions) \,of \,right \,DF = N(Partitions) \,after \,crossJoin \,DF\)</ul><li>Large DataFrame Cross Join<ul><li>반면 Join의 대상의 크기가 클 경우 데이터프레임의 파티션은 다음과 같을 것입니다.<li>\(\ N(Partitions) \, after \, crossJoin DF = N(Partitions) \, of \, left \, DF * N(Partitions) \, of \, right \, DF\)</ul></ul><h3 id="data-preprocessing-in-rfm">Data preprocessing in RFM</h3><p>간단한 배경 설명을 하고 스파크 튜닝 부분을 전개하겠습니다. RFM 모델은 이커머스상에서 활동한 고객 행동 데이터 중 R(Recency), F(Frequency), M(Monetary value)를 인자로 사용하여 고객을 세분화합니다. 최종적인 결과는 아래의 이미지와 유사하지만 Monetary value가 추가적으로 포함된다는 점과 내부적인 고객 세분화와 연관된 연산 과정이 다릅니다.</p><p><br /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 " data-src="/assets/img/post_img/RFM_clevertap.png" alt="spark" /></p><p><br /></p><p>전체 고객군에 관한 분포의 왜곡 현상을 고려하여 ‘New User’군과 다른 군들을 나뉘어 RFM 모델을 독립적으로 적용하였습니다 . 독립적인 연산 과정 후 각 군들을 합친 후 통계량을 내는 부분에 있어서 스파크 파티션의 ‘Data Skewness’를 발견할 수 있었습니다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">df</span><span class="p">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">new_user_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'max_sessionSeq'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">new_user_df</span> <span class="o">=</span> <span class="n">new_user_df</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s">'max_sessionSeq'</span><span class="p">,</span> <span class="s">'frequency'</span><span class="p">,</span> <span class="s">'recency'</span><span class="p">)</span>
<span class="n">new_user_df</span> <span class="o">=</span> <span class="n">new_user_df</span><span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'segmentation'</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="s">"00"</span><span class="p">))</span> \
        <span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">'cookieId'</span><span class="p">,</span> <span class="s">'segmentation'</span><span class="p">,</span> <span class="s">'monetary'</span><span class="p">,</span><span class="s">'session_frequency'</span><span class="p">,</span> <span class="s">'recency_date'</span><span class="p">)</span>
        
<span class="k">print</span><span class="p">(</span><span class="s">'New User Partition Size'</span><span class="p">)</span>
<span class="n">df_length</span> <span class="o">=</span> <span class="n">new_user_df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="n">glom</span><span class="p">().</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_length</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'All partitino Size in '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'max Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'min Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>##
[35287, 34389, 35438, 34416, 34564, 34982, 35383, 35342, 34667, 34272, 35282, 34464, 34409, 34453, 35122, 35143, 35321, 35238, 34568, 34456, 34455, 34457, 34428, 34116, 35194, 12446]
All partitino Size in  26
max Partition Size :  35438
min Partition Size :  12446
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">print</span><span class="p">(</span><span class="s">'Before First Cross Join'</span><span class="p">)</span>
<span class="n">df_length</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="n">glom</span><span class="p">().</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_length</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'All partitino Size in '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'max Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'min Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>All partitino Size in  1000
max Partition Size :  13
min Partition Size :  0
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="s">'frequency'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'mean_frequency'</span><span class="p">),</span>
               <span class="n">stddev</span><span class="p">(</span><span class="s">'frequency'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'std_frequency'</span><span class="p">),</span>
               <span class="n">mean</span><span class="p">(</span><span class="s">'monetary'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'mean_monetary'</span><span class="p">),</span>
               <span class="n">stddev</span><span class="p">(</span><span class="s">'monetary'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'std_monetary'</span><span class="p">),</span>
               <span class="n">mean</span><span class="p">(</span><span class="s">'recency'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'mean_recency'</span><span class="p">),</span>
               <span class="n">stddev</span><span class="p">(</span><span class="s">'recency'</span><span class="p">).</span><span class="n">alias</span><span class="p">(</span><span class="s">'std_recency'</span><span class="p">)</span>
               <span class="p">)</span> \
    <span class="p">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> \
    <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'scaled_frequency'</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'frequency'</span><span class="p">)</span> <span class="o">-</span> <span class="n">col</span><span class="p">(</span><span class="s">'mean_frequency'</span><span class="p">))</span> <span class="o">/</span> <span class="n">col</span><span class="p">(</span><span class="s">'std_frequency'</span><span class="p">))</span> \
    <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'scaled_monetary'</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'monetary'</span><span class="p">)</span> <span class="o">-</span> <span class="n">col</span><span class="p">(</span><span class="s">'mean_monetary'</span><span class="p">))</span> <span class="o">/</span> <span class="n">col</span><span class="p">(</span><span class="s">'std_monetary'</span><span class="p">))</span> \
    <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'scaled_recency'</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'recency'</span><span class="p">)</span> <span class="o">-</span> <span class="n">col</span><span class="p">(</span><span class="s">'mean_recency'</span><span class="p">))</span> <span class="o">/</span> <span class="n">col</span><span class="p">(</span><span class="s">'std_recency'</span><span class="p">))</span>
    
<span class="k">print</span><span class="p">(</span><span class="s">'After first Cross Join &amp; Preprocessing before second cross join'</span><span class="p">)</span>
<span class="n">df_length</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="n">glom</span><span class="p">().</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'All partitino Size in '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'max Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'min Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>All partitino Size in  1000
max Partition Size :  13
min Partition Size :  0
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">new_user_df</span> <span class="o">=</span> <span class="n">new_user_df</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">'cookieId'</span><span class="p">,</span> <span class="s">'session_frequency'</span><span class="p">,</span> <span class="s">'monetary'</span><span class="p">,</span> <span class="s">'recency_date'</span><span class="p">,</span> <span class="s">'segmentation'</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">union</span><span class="p">(</span><span class="n">new_user_df</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">unpersist</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'After Union cross join'</span><span class="p">)</span>
<span class="n">df_length</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">rdd</span><span class="p">.</span><span class="n">glom</span><span class="p">().</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'All partitino Size in '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'max Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'min Partition Size : '</span><span class="p">,</span> <span class="n">pa</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">df_length</span><span class="p">))</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>All partitino Size in  2000
max Partition Size :  971
min Partition Size :  0
</pre></table></code></div></div><p><br /></p><p>Join시 해당 파티션(Partition) 내에서 같은 키값을 갖는 데이터가 있어야 합니다. 만약 그렇지 않으면 주어진 키의 갯수와 파티션 내의 데이터를 맞추는 작업을 하는데 많은 비용이 발생합니다. CrossJoin을 함에 있어서 같은 데이터프레임을 활용하고 있으므로 앞에서 살펴본 crossJoin의 첫번째 경우와 같습니다.</p><p><br /></p><p>다시 말해서 파티션의 크키의 변동이 없음을 확인할 수 있습니다. 하지만 새로운 고객군을 기존 데이터프레임과 합칠 때 개별적인 파티션의 크기 차이의 심화로 이후의 작업에서 연산 속도가 느림을 발견할 수 있었습니다. 그래서 드라이버의 maxResultSize를 1024가 아닌 더 높은 값으로 설정하여 Stage Failure를 막으면서 new_user_df와 df의 파티션 수를 최적화하고 Garbage Collection Tuning을 한 결과 어플리케이션의 실행 시간을 단축할 수 있었습니다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spark/'>Spark</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spark/" class="post-tag no-text-decoration" >Spark</a> <a href="/tags/rdd/" class="post-tag no-text-decoration" >RDD</a> <a href="/tags/negative_sampling/" class="post-tag no-text-decoration" >Negative_Sampling</a> <a href="/tags/data_sampling/" class="post-tag no-text-decoration" >Data_sampling</a> <a href="/tags/spark_tuning/" class="post-tag no-text-decoration" >Spark_Tuning</a> <a href="/tags/rfm/" class="post-tag no-text-decoration" >RFM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Spark Tuning과 관련된 몇 가지 발견들 - Kwon_sun_cheol&url=https://classicmania.github.io/posts/SparkTuningPart1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Spark Tuning과 관련된 몇 가지 발견들 - Kwon_sun_cheol&u=https://classicmania.github.io/posts/SparkTuningPart1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Spark Tuning과 관련된 몇 가지 발견들 - Kwon_sun_cheol&url=https://classicmania.github.io/posts/SparkTuningPart1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Imbalanced_classification_part1/"><div class="card-body"> <span class="timeago small" > Jan 9 <i class="unloaded">2021-01-09T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Imbalanced data classification part1</h3><div class="text-muted small"><p> Cute imbalanced image1 지도학습에서 분류 문제를 다룰 때 Imbalanced classification인 경우가 많았습니다. 예를 들어 이커머스 데이터를 활용하여 개별적인 고객의 이탈을 예측하는 모델을 만들 때 위의 문제를 발견할 수 있었습니다. 실무에서 이탈 예측 태스크를 진행하면서 ‘불균형 데이터를 어떻게 다룰 것인가’에 대...</p></div></div></a></div><div class="card"> <a href="/posts/Similarityandmetrics/"><div class="card-body"> <span class="timeago small" > Apr 18 <i class="unloaded">2021-04-18T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recommendation system for E-commerce / Similarity and Metrics</h3><div class="text-muted small"><p> 지난 시간에는 팀원들과 Matrix Completion과 관련된 SVD1, ALS2, SGD의 개념을 살펴보았습니다. 이번 시간에는 이커머스에서 추천 모델의 최종 단계인 유사도(Similarity)를 계산하는 부분과 지표(Metric)를 점검해보았습니다. Similarity 상품 또는 고객을 벡터로 표현한 뒤 벡터 간의 유사...</p></div></div></a></div><div class="card"> <a href="/posts/User2userItem2Item/"><div class="card-body"> <span class="timeago small" > Mar 21 <i class="unloaded">2021-03-21T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recommendation system for E-commerce / Collaborative Filtering</h3><div class="text-muted small"><p> 현재 추천 시스템이 적용되고 있고 고도화를 진행하고 있는 시점에서 최근 팀원분들과 추천 스터디를 플립러닝(flipped learning) 방식으로 진행하게 되었습니다. 우선 팀원들과 함께 추천의 내재적인 부분과 기본적인 내용들을 확인하고 놓칠 수 있는 부분들을 점검하고 있습니다. 이번주는 팀원들과 함께 중소형 트래픽 규모를 가...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Imbalanced_classification_part2/" class="btn btn-outline-primary"><p>Imbalanced data classification part2</p></a> <a href="/posts/User2userItem2Item/" class="btn btn-outline-primary"><p>Recommendation system for E-commerce / Collaborative Filtering</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/classicmania">Kwon_suncheol</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/similarity/">Similarity</a> <a class="post-tag" href="/tags/recommendation/">Recommendation</a> <a class="post-tag" href="/tags/imbalanced_data/">Imbalanced_data</a> <a class="post-tag" href="/tags/evaluation_metric/">Evaluation_metric</a> <a class="post-tag" href="/tags/data_sampling/">Data_sampling</a> <a class="post-tag" href="/tags/classification/">Classification</a> <a class="post-tag" href="/tags/churn_prediction/">Churn_prediction</a> <a class="post-tag" href="/tags/stack/">stack</a> <a class="post-tag" href="/tags/queue/">queue</a> <a class="post-tag" href="/tags/linked_list/">linked_list</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://classicmania.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
